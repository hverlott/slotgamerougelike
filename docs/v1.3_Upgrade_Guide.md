# Zombie Spin Defense - 版本升级说明书 (v1.2 -> v1.3)

> **文档状态**: 正式发布  
> **发布日期**: 2025-12-20  
> **适用版本**: v1.3.0  

---

## 1. 版本升级概述

### 1.1 版本信息
- **当前版本**: v1.2 (Base)
- **目标版本**: v1.3 (Mobile & Combat Enhanced)
- **升级类型**: 功能特性更新 (Feature Update)

### 1.2 升级目的
本次 v1.3 版本升级主要致力于解决移动端体验问题及战斗逻辑的精确性。通过引入 **FIFO 目标锁定机制** 解决了攻击目标混乱的问题，并通过全新的 **GyroController (体感控制)** 和 **Genshin-Style UI** 极大提升了移动设备的沉浸感和操作便捷性。同时，修复了 v1.2 版本中存在的 PixiJS v8 兼容性警告及部分状态机死锁 bug。

---

## 2. 功能变更清单

### 2.1 ⚔️ 战斗系统 (Combat System)
| 模块 | 功能点 | 说明 |
| :--- | :--- | :--- |
| `EnemySystem` | **FIFO 目标选择** | 实现了 `pickTarget()` 方法。攻击逻辑从"随机"变更为"优先攻击最前排僵尸" (Sort by Row > Y > X)。 |
| `BulletSystem` | **视觉锁定准星** | 新增 `drawReticle(target)`。当子弹锁定目标时，显示动态旋转的红色锁定框，提升打击反馈。 |
| `BulletSystem` | **子弹旋转平滑** | 修复了追踪子弹在改变目标时的瞬时转向问题，引入角度插值 (LERP) 实现平滑转弯。 |

### 2.2 📱 交互与控制 (Interaction)
| 模块 | 功能点 | 说明 |
| :--- | :--- | :--- |
| `GyroController` | **视差倾斜 (Parallax)** | 根据设备倾斜角度微调游戏舞台 (Stage) 角度，营造裸眼 3D 悬浮感。 |
| `GyroController` | **摇一摇 (Shake)** | 新增加速度检测，用力摇晃手机即可触发/取消 "自动旋转" (Auto Spin)。 |
| `main.js` | **触控区域调节** | 新增 `window.adjustTouchArea(scale)` 全局方法，支持动态调整按钮点击热区大小。 |

### 2.3 🎨 UI/UX 界面
| 模块 | 功能点 | 说明 |
| :--- | :--- | :--- |
| `index.html` | **Genshin-Style 主题** | 全面重写 CSS。引入 "磨砂玻璃 (Glassmorphism)"、"胶囊按钮"、"微渐变" 等设计元素。 |
| `index.html` | **移动端响应式** | 新增 Bottom Sheet 布局。在手机端侧边栏自动折叠到底部，并支持点击展开。 |
| `main.js` | **Ripple 点击特效** | 为所有按钮添加 Material Design 风格的水波纹点击反馈。 |

### 2.4 🔧 系统与稳定性
| 模块 | 功能点 | 说明 |
| :--- | :--- | :--- |
| `Logger` | **日志系统** | 新增 `src/utils/Logger.js`，支持分级日志记录与导出，方便排查线上问题。 |
| `AutoRepair` | **自动修复** | 新增 `AutoRepairSystem`，监控状态机超时和死锁，自动重置游戏状态。 |

---

## 3. API 变更记录

### 3.1 新增 API

#### `GyroController` (src/systems/GyroController.js)
负责处理设备体感数据。
```javascript
// 初始化
const gyro = new GyroController(game, {
  sensitivity: 0.08, // 灵敏度
  maxAngle: 0.15,    // 最大倾斜弧度
  onShake: () => { console.log('Shaken!'); }
});

// 启动 (需在用户交互后调用以获取 iOS 权限)
gyro.start();
```

#### 全局调试/设置 API (Window作用域)
用于运行时动态调整参数。
```javascript
// 设置体感灵敏度 (默认 0.08)
window.setGyroSensitivity(0.2);

// 调整按钮触控区域倍率 (默认 1.0)
window.adjustTouchArea(1.5);
```

### 3.2 修改 API

#### `EnemySystem.pickTarget()`
*   **变更前**: 无此公共方法，外部直接访问 `zombies` 数组随机选取。
*   **变更后**: 返回优先级最高的 `Zombie` 对象。
*   **兼容性**: 向下兼容，若不调用此方法仍可访问 `zombies` 数组，但建议改用此方法以获得正确的攻击逻辑。

#### `BulletSystem.fireBulletTo(target, options)`
*   **变更**: 内部增加了 `validateSpawnPoint(x, y)` 校验逻辑。
*   **影响**: 若传入的 `startX/startY` 超出屏幕缓冲区 (padding=100)，会打印警告并强制修正坐标，防止子弹在屏幕外无限飞行。

---

## 4. 数据存储变更

本次升级主要涉及前端逻辑，**无后端数据库 Schema 变更**。
但在本地存储 (`localStorage`) 或内存状态管理中，有以下调整：

### 4.1 状态机 (StateMachine)
*   **新增状态**: 无新增状态，但 `RESOLVING` 和 `SPINNING` 状态增加了超时保护机制 (AutoRepair)。

### 4.2 配置持久化 (建议)
若需持久化用户的 UI 设置，建议在 `localStorage` 中增加以下 Key：
| Key | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `setting_gyro_enabled` | Boolean | `true` | 是否开启体感 |
| `setting_touch_scale` | Number | `1.0` | 触控区域缩放比 |

---

## 5. 配置项变更

### 5.1 CSS 变量 (`index.html` :root)
新增了一套全新的设计系统变量，如需自定义主题请修改此处：
```css
:root {
  --primary: #3B4255;       /* 主色调 */
  --accent: #4CC9F0;        /* 强调色 (科技蓝) */
  --win: #FFB800;           /* 赢分金 */
  --panel: rgba(255, 255, 255, 0.90); /* 面板背景 */
  --sidebar-width: 380px;   /* 侧边栏宽度 */
}
```

### 5.2 游戏常量 (`main.js`)
新增了 Gyro 配置块：
```javascript
const gyroController = new GyroController(game, {
  sensitivity: 0.08,  // [新增] 视差灵敏度
  maxAngle: 0.15,     // [新增] 最大倾斜角度
  smoothFactor: 0.1   // [新增] 平滑插值因子
});
```

---

## 6. 依赖项更新

### 6.1 核心库版本
| 库名称 | v1.2 版本 | v1.3 版本 | 说明 |
| :--- | :--- | :--- | :--- |
| `pixi.js` | ^8.0.0 | **^8.14.3** | 必须升级以支持 `renderer.generateTexture` 新 API 并修复 `stroke` 废弃警告。 |
| `gsap` | ^3.14.0 | ^3.14.2 | 保持最新以获得最佳动画性能。 |

### 6.2 兼容性注意
*   **PixiJS v8 Breaking Change**: `Graphics.drawCircle` 等旧 API 已完全废弃，必须使用 `Graphics.circle`。v1.3 代码已全量适配。
*   **iOS 权限**: iOS 13+ 需要显式调用 `DeviceMotionEvent.requestPermission()`，v1.3 已在 `GyroController` 中封装此逻辑。

---

## 7. 已知问题 (Known Issues)

1.  **HTTPS 限制**: 体感功能 (`DeviceOrientation`) 在现代浏览器中必须通过 **HTTPS** 或 **localhost** 访问，HTTP 环境下将自动失效。
2.  **iOS 首次交互**: iOS Safari 要求必须由用户手势 (Tap) 触发权限请求。若用户在首次弹窗中点击"拒绝"，需清除网站数据才能再次唤起。
3.  **部分旧设备性能**: `backdrop-filter: blur()` (毛玻璃效果) 在低端安卓设备上可能导致掉帧。
    *   *临时方案*: 在 CSS 中为低端机型禁用滤镜: `@supports not (backdrop-filter: blur(10px)) { ... }`

---

## 8. 升级步骤指南

### 步骤 1: 备份
备份当前项目的所有源代码，特别是 `src/systems/` 目录和 `index.html`。

### 步骤 2: 更新依赖
运行 npm 命令更新 PixiJS：
```bash
npm install pixi.js@latest
```

### 步骤 3: 文件替换
将以下新文件复制到对应目录：
1.  `src/systems/GyroController.js` (新增)
2.  `src/utils/Logger.js` (新增)
3.  `src/systems/AutoRepairSystem.js` (新增)

覆盖以下文件 (**注意保留原有业务逻辑配置**):
1.  `src/systems/EnemySystem.js` (FIFO 逻辑)
2.  `src/systems/BulletSystem.js` (Reticle & Fixes)
3.  `src/main.js` (Gyro 集成)
4.  `index.html` (UI 样式)

### 步骤 4: 验证
1.  启动开发服务器: `npm run dev`
2.  **桌面端验证**:
    *   点击 "Spin"，检查是否有报错。
    *   检查 UI 是否为新的 "Genshin-Style" (蓝/白/金配色)。
3.  **移动端验证**:
    *   使用手机访问 (确保同一局域网或 localhost)。
    *   点击 "旋转"，允许传感器权限。
    *   摇晃手机，观察是否触发 "Auto Spin"。
    *   倾斜手机，观察背景是否有视差移动。

### 5. 回滚方案
若升级失败：
1.  删除 `src/systems/GyroController.js`。
2.  恢复 `index.html` 至备份版本。
3.  回退 `src/main.js` 中关于 `gyroController` 的实例化代码。

---
*文档生成时间: 2025-12-20 By AI Assistant*
